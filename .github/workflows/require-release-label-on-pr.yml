name: Require release label on PR

on:
  pull_request:
    types:
      [
        opened,
        edited,
        reopened,
        labeled,
        unlabeled,
        synchronize,
        ready_for_review,
      ]

jobs:
  require-label:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Check PR target
        id: check
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const pr = context.payload.pull_request
            if (!pr) {
              core.info('No pull_request payload available — skipping label check.')
              return
            }

            const base = pr.base && pr.base.ref ? pr.base.ref : ''
            // Only enforce for PRs targeting `main` (adjust if you use a different default branch)
            if (base !== 'main') {
              core.info(`PR targets '${base}' — label requirement only enforced for 'main'. Skipping.`)
              return
            }

            const labels = (pr.labels || []).map(l => l.name.toLowerCase())
            const required = ['major','minor','patch']
            const ok = required.some(r => labels.includes(r))
            if (!ok) {
              const msg = `This repository requires one of the release labels: ${required.join(', ')}. Please add one of these labels before merging.`
              // Post or update a single reminder comment on the PR to avoid spamming
              try {
                const { owner, repo } = context.repo
                const marker = '<!-- release-label-check -->'
                const body = `${marker}\n${msg}`

                // get existing comments on the PR and look for our marker
                const existingComments = await github.rest.issues.listComments({ owner, repo, issue_number: pr.number })
                // find a comment created by this app/bot that contains our marker
                let botLogin = null
                try {
                  botLogin = (await github.rest.users.getAuthenticated()).data.login
                } catch (e) {
                  core.info('Could not determine authenticated user login; falling back to matching marker only')
                }

                const found = existingComments.data.find(c => c.body && c.body.includes(marker) && (botLogin ? c.user && c.user.login === botLogin : true))
                if (found) {
                  await github.rest.issues.updateComment({ owner, repo, comment_id: found.id, body })
                } else {
                  await github.rest.issues.createComment({ owner, repo, issue_number: pr.number, body })
                }
              } catch (e) {
                core.warning('Failed to post or update reminder comment: ' + e.message)
              }
              core.setFailed(msg)
            } else {
              core.info('Release label present — pass')
            }
