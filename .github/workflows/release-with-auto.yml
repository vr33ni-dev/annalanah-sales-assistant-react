name: Release (auto)

permissions:
  contents: write
  issues: write
  pull-requests: write

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  release:
    runs-on: ubuntu-latest
    concurrency:
      group: release-with-auto-${{ github.ref }}
      cancel-in-progress: false
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: |
          set -euo pipefail
          # Use npm install here (not npm ci) because package.json was edited in-tree
          # and the lockfile may not yet match on CI. This installs dependencies
          # including the pinned 'auto' devDependency.
          npm install --no-audit --no-fund

      # auto is installed by `npm ci` from devDependencies (pinned in package.json)

      - name: Choose token for pushing tags/commits
        id: choose-token
        env:
          RELEASE_PAT: ${{ secrets.RELEASE_PAT }}
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          set -euo pipefail
          # Prefer a user-provided PAT (recommended when branch protection prevents pushes by GH_TOKEN).
          if [ -n "${RELEASE_PAT:-}" ]; then
            echo "Using RELEASE_PAT for release actions"
            echo "AUTO_TOKEN=${RELEASE_PAT}" >> "$GITHUB_ENV"
          else
            echo "No RELEASE_PAT configured; falling back to GH_TOKEN. If protected branches prevent pushes, create a RELEASE_PAT in repo secrets."
            echo "AUTO_TOKEN=${GH_TOKEN}" >> "$GITHUB_ENV"
          fi

      - name: Expose GH_TOKEN for Auto
        run: |
          set -euo pipefail
          # Make GH_TOKEN available for the auto CLI which expects GH_TOKEN in env
          if [ -n "${AUTO_TOKEN:-}" ]; then
            echo "GH_TOKEN=${AUTO_TOKEN}" >> "$GITHUB_ENV"
          fi

      - name: Run auto (create bump commit, tag, changelog, release)
        env:
          # Expose repo context and token for auto; AUTO_TOKEN is written to $GITHUB_ENV in the previous step
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_EVENT_NAME: ${{ github.event_name }}
          GITHUB_EVENT_PATH: ${{ github.event_path }}
          GITHUB_SHA: ${{ github.sha }}
        run: |
          set -euo pipefail
          # AUTO_TOKEN is available as an environment variable (written to GITHUB_ENV above)
          echo "STEP: running auto to create release"
          # Use the package script so the repo lockfile controls the auto version.
          npm run release:auto
